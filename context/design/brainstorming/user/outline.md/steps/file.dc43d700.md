---
timestamp: 'Thu Oct 23 2025 23:34:01 GMT-0400 (Eastern Daylight Time)'
parent: '[[../20251023_233401.a5503f10.md]]'
content_id: dc43d700e282f94a83820aec904bdad89d01cbbec47d3278d6d4dacf5c69e9b9
---

# file: src/UserAccount/UserAccountConcept.ts

```typescript
import { Collection, Db } from "npm:mongodb";
import { Empty, ID } from "@utils/types.ts";
import { freshID } from "@utils/database.ts"; // Required for generating new entity IDs

// Declare collection prefix, using the concept name for clarity in the database
const PREFIX = "UserAccount" + ".";

// Define internal ID types for the entities managed by this concept.
// These are branded string types for better type safety and clarity, consistent with `ID`.
type User = ID;
type ShareLink = ID;

// Define specific types for data fields that aren't primitive strings/numbers.
// TimeOfDay: Represented as a string, e.g., "14:30" for 2:30 PM.
type TimeOfDay = string;
// DateTime: Represented using the standard JavaScript Date object for easy manipulation and storage.
type DateTime = Date;

/**
 * Interface representing the structure of a 'User' document in the MongoDB collection.
 * Corresponds to "a set of Users with ..." in the concept state.
 */
interface UserDoc {
  _id: User; // The unique identifier for the user, generated by freshID()
  username: string; // The user's chosen username
  passwordHash: string; // A hashed version of the user's password for security
  reminderTime: TimeOfDay | null; // The user's preferred reminder time, nullable if not set
  shareLinks: ShareLink[]; // An array of IDs of ShareLink entities owned by this user
}

/**
 * Interface representing the structure of a 'ShareLink' document in the MongoDB collection.
 * Corresponds to "a set of ShareLinks with ..." in the concept state.
 */
interface ShareLinkDoc {
  _id: ShareLink; // The unique identifier for the share link, generated by freshID()
  token: string; // The actual token string that users will use for access
  expiry: DateTime; // The date and time when this share link expires
  owner: User; // The ID of the user who created this share link
}

/**
 * **concept** UserAccount
 *
 * **purpose** To enable the creation, management, and personalization of a user's account within the application.
 *
 * **principle** An athlete registers for an account, personalizes their notification reminder time,
 * and can generate or revoke temporary share links to their data, all managed through their account.
 */
export default class UserAccountConcept {
  // MongoDB collection for storing User documents
  users: Collection<UserDoc>;
  // MongoDB collection for storing ShareLink documents
  shareLinks: Collection<ShareLinkDoc>;

  /**
   * Constructor for the UserAccountConcept.
   * Initializes the MongoDB collections used by this concept.
   * @param db The MongoDB database instance to use for collections.
   */
  constructor(private readonly db: Db) {
    this.users = this.db.collection(PREFIX + "users");
    this.shareLinks = this.db.collection(PREFIX + "shareLinks");
  }

  /**
   * `register (username: String, password: String) : (user: User)`
   *
   * **requires** `username` is not already taken
   *
   * **effects** creates a new `User`, assigns the provided `username` and `passwordHash` (of the `password`),
   * sets `reminderTime` to a default value (e.g., null), and initializes `shareLinks` as an empty set.
   *
   * @param params An object containing the username and password for registration.
   * @returns A Promise resolving to an object with the new user's ID on success, or an error message.
   */
  async register(
    { username, password }: { username: string; password: string; },
  ): Promise<{ user: User; } | { error: string; }> {
    // TODO: Implement logic to check if username is already taken.
    // TODO: Hash the provided password using a secure hashing algorithm.
    // TODO: Generate a new unique ID for the user using `freshID()`.
    // TODO: Create a new UserDoc object with the generated ID, username, hashed password,
    //       default reminderTime (e.g., null), and an empty array for shareLinks.
    // TODO: Insert the new UserDoc into the `users` collection.
    // TODO: On success, return `{ user: newUser._id }`.
    // TODO: On failure (e.g., username taken, hashing error), return `{ error: "..." }`.
    return { user: "TODO_NEW_USER_ID" as User }; // Placeholder return
  }

  /**
   * `setReminderTime (user: User, time: TimeOfDay)`
   *
   * **requires** `user` exists
   *
   * **effects** sets `user.reminderTime := time`
   *
   * @param params An object containing the user's ID and the new reminder time.
   * @returns A Promise resolving to an empty object on success, or an error message.
   */
  async setReminderTime(
    { user, time }: { user: User; time: TimeOfDay; },
  ): Promise<Empty | { error: string; }> {
    // TODO: Implement logic to verify if the 'user' exists in the `users` collection.
    // TODO: Update the `reminderTime` field of the specified user's document to the new 'time'.
    // TODO: On success, return `{}`.
    // TODO: On failure (e.g., user not found), return `{ error: "..." }`.
    return {}; // Placeholder return
  }

  /**
   * `createShareLink (owner: User, ttlSeconds: Number) : (token: String)`
   *
   * **requires** `owner` exists
   *
   * **effects** creates a new `ShareLink` with a randomly generated `token`,
   * sets `expiry = now + ttlSeconds`, associates `owner` with the provided `User`,
   * and adds this `ShareLink` to `owner.shareLinks`.
   *
   * @param params An object containing the owner's ID and the time-to-live for the link in seconds.
   * @returns A Promise resolving to an object with the generated token on success, or an error message.
   */
  async createShareLink(
    { owner, ttlSeconds }: { owner: User; ttlSeconds: number; },
  ): Promise<{ token: string; } | { error: string; }> {
    // TODO: Implement logic to verify if the 'owner' exists in the `users` collection.
    // TODO: Generate a secure, unique token string. This token will also serve as the _id value.
    // TODO: Calculate the expiry DateTime: `new Date(Date.now() + ttlSeconds * 1000)`.
    // TODO: Create a new ShareLinkDoc with the generated ID (token), token string, expiry, and owner ID.
    // TODO: Insert the new ShareLinkDoc into the `shareLinks` collection.
    // TODO: Add the generated ShareLink's _id to the `shareLinks` array of the owner's UserDoc.
    // TODO: On success, return `{ token: generatedToken }`.
    // TODO: On failure (e.g., owner not found, token generation error), return `{ error: "..." }`.
    return { token: "TODO_GENERATED_TOKEN" }; // Placeholder return
  }

  /**
   * `revokeShareLink (owner: User, token: String)`
   *
   * **requires** a `ShareLink` exists with the given `token` and its `owner` is the provided `owner`
   *
   * **effects** removes the `ShareLink` with the specified `token` from `owner.shareLinks`
   * and deletes the `ShareLink` itself.
   *
   * @param params An object containing the owner's ID and the token of the share link to revoke.
   * @returns A Promise resolving to an empty object on success, or an error message.
   */
  async revokeShareLink(
    { owner, token }: { owner: User; token: string; },
  ): Promise<Empty | { error: string; }> {
    // TODO: Implement logic to find the ShareLink by its token.
    // TODO: Verify that the found ShareLink's `owner` matches the provided 'owner' ID.
    // TODO: Delete the ShareLinkDoc from the `shareLinks` collection using its _id (which is the token).
    // TODO: Remove the ShareLink's _id (token) from the `shareLinks` array of the owner's UserDoc.
    // TODO: On success, return `{}`.
    // TODO: On failure (e.g., link not found, owner mismatch), return `{ error: "..." }`.
    return {}; // Placeholder return
  }
}
```
